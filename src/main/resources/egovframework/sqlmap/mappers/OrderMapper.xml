<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.logitics_track_360.order.dao.OrderMapper">

  <insert id="insert" parameterType="kr.co.logitics_track_360.order.dto.OrderCreateRequestDto">
	INSERT INTO TBL_ORDER (
	    ORDER_ID,
	    USER_ID,
	    TITLE,
	    DESCRIPTION,
	    STATUS,
        CREATED_AT,
        UPDATED_AT
	) VALUES (
        SEQ_ORDER_ID.NEXTVAL,
	    #{userId, jdbcType=VARCHAR},
        #{title, jdbcType=VARCHAR},
	    #{description, jdbcType=VARCHAR},
        #{status, jdbcType=VARCHAR},
        SYSDATE,
        SYSDATE
	  )
	<selectKey keyProperty="orderId" resultType="long" order="AFTER">
	  SELECT SEQ_ORDER_ID.CURRVAL FROM DUAL
    </selectKey>
  </insert>
	
  <select id="selectOrderList" parameterType="kr.co.logitics_track_360.order.dto.OrderSearchRequestDto" resultType="kr.co.logitics_track_360.order.vo.OrderVO">
    SELECT o.ORDER_ID    AS orderId,
	       o.USER_ID     AS userId,
	       o.TITLE       AS title,
	       o.DESCRIPTION AS description,
	       o.STATUS      AS status,
	       u.NAME        AS userName,
	       o.CREATED_AT  AS createdAt,
	       o.UPDATED_AT  AS updatedAt
	FROM TBL_ORDER o
	LEFT JOIN TBL_USER u ON o.USER_ID = u.USER_ID
	WHERE 1=1
	<if test="userId != null and userId != ''">
      AND o.USER_ID = #{userId, jdbcType=VARCHAR}
    </if>
	<if test="keyword != null and keyword != ''">
	  AND (o.TITLE LIKE '%' || #{keyword, jdbcType=VARCHAR} || '%' OR o.DESCRIPTION LIKE '%' || #{keyword, jdbcType=VARCHAR} || '%')
	</if>
	<if test="status != null and status != ''">
	  AND o.STATUS = #{status, jdbcType=VARCHAR}
	</if>
	ORDER BY o.CREATED_AT DESC
  </select>
	
  <select id="selectOrder" parameterType="String" resultType="kr.co.logitics_track_360.order.vo.OrderVO">
	SELECT o.ORDER_ID    AS orderId,
	       o.USER_ID     AS userId,
	       o.TITLE       AS title,
	       o.DESCRIPTION AS description,
	       o.STATUS      AS status,
	       u.NAME        AS userName,
	       o.CREATED_AT  AS createdAt,
	       o.UPDATED_AT  AS updatedAt
	FROM TBL_ORDER o
	LEFT JOIN TBL_USER u 
	ON o.USER_ID = u.USER_ID
	WHERE o.ORDER_ID = #{orderId, jdbcType=VARCHAR}
  </select>
	
  <update id="updateOrderStatus" parameterType="map">
	UPDATE TBL_ORDER
	SET STATUS     = #{status, jdbcType=VARCHAR}, 
	    UPDATED_AT = SYSDATE
	WHERE ORDER_ID = #{orderId, jdbcType=VARCHAR}
  </update>
</mapper>